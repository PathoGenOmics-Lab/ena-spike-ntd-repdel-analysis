from pathlib import Path
import pandas as pd


SEARCH_DF = None


def read_search_df(wildcards):
    global SEARCH_DF
    if SEARCH_DF is None:
        SEARCH_DF = pd.read_csv(checkpoints.search_ena.get(**wildcards).output.table, sep="\t", low_memory=False)


def build_fastqc_targets(wildcards):
    read_search_df(wildcards)
    return [
        f"output/preproc/fastqc/{study}/{sample}/{platform}/{run}/{layout}_{strategy}" \
        for (platform, study, sample, run, layout, strategy), _ in SEARCH_DF.groupby(["instrument_platform", "study_accession", "sample_accession", "run_accession", "library_layout", "library_strategy"])
    ]


def build_qc_targets(wildcards):
    read_search_df(wildcards)
    return [
        f"output/preproc/fastp/{study}/{sample}/{platform}/{run}/{layout}_{strategy}/report.html" \
        for (platform, study, sample, run, layout, strategy), _ in SEARCH_DF.groupby(["instrument_platform", "study_accession", "sample_accession", "run_accession", "library_layout", "library_strategy"])
    ]


def build_sorted_bam_targets(wildcards):
    read_search_df(wildcards)
    return [
        f"output/mappings/sorted_bam/{study}/{sample}/{platform}/{run}/{layout}_{strategy}/sample.sorted.bam" \
        for (platform, study, sample, run, layout, strategy), _ in SEARCH_DF.groupby(["instrument_platform", "study_accession", "sample_accession", "run_accession", "library_layout", "library_strategy"])
    ]


def build_multiqc_per_study_targets(wildcards):
    read_search_df(wildcards)
    return [
        f"output/preproc/multiqc/{study}" for study, _ in SEARCH_DF.groupby(["study_accession"])
    ]


rule all:
    input:
        "output/ena/search.tsv",
        "output/ena/report/search/summary.pdf",
        build_multiqc_per_study_targets,
        build_qc_targets,
        build_sorted_bam_targets


rule efetch_fasta_reference:
    params:
        accession = "NC_045512.2"
    output:
        fasta = "output/reference.fasta"
    shell: "curl -s -o {output.fasta:q} https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nuccore&id={params.accession}&rettype=fasta"


include: "rules/ena.smk"
include: "rules/preproc.smk"
include: "rules/mapping.smk"
